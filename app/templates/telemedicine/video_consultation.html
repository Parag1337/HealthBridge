{% extends "base.html" %}

{% block title %}Video Consultation - HealthBridge Ai{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Main Video Area -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-video"></i> Video Consultation
                        {% if consultation.status == 'active' %}
                        <span class="badge bg-success ms-2">Live</span>
                        {% endif %}
                    </h5>
                    <div>
                        <span class="badge bg-light text-dark" id="consultationTimer">00:00</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Video Container -->
                    <div class="video-container" style="background: #000; min-height: 400px; position: relative;">
                        <!-- Remote Video (Doctor) -->
                        <video id="remoteVideo" autoplay playsinline style="width: 100%; height: 400px; object-fit: cover;">
                            <source src="" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                        
                        <!-- Local Video (Patient) - Picture-in-Picture -->
                        <div style="position: absolute; top: 10px; right: 10px; width: 200px; height: 150px; border: 2px solid #fff; border-radius: 8px; overflow: hidden;">
                            <video id="localVideo" autoplay muted playsinline style="width: 100%; height: 100%; object-fit: cover;">
                                <source src="" type="video/mp4">
                            </video>
                        </div>
                        
                        <!-- Connection Status Overlay -->
                        <div id="connectionStatus" class="position-absolute top-50 start-50 translate-middle text-center text-white" style="display: none;">
                            <div class="spinner-border text-light mb-3" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <h5>Connecting to consultation...</h5>
                            <p>Please wait while we establish the connection.</p>
                        </div>
                        
                        <!-- Waiting for Doctor Overlay -->
                        <div id="waitingOverlay" class="position-absolute top-50 start-50 translate-middle text-center text-white" {% if consultation.status != 'scheduled' %}style="display: none;"{% endif %}>
                            <i class="fas fa-user-md fa-4x mb-3"></i>
                            <h5>Waiting for Dr. {{ appointment.doctor.first_name }} {{ appointment.doctor.last_name }}</h5>
                            <p>Your consultation is scheduled for {{ appointment.time.strftime('%I:%M %p') }}</p>
                            <div class="mt-3">
                                <div class="spinner-border text-light" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Video Controls -->
                    <div class="bg-dark p-3">
                        <div class="d-flex justify-content-center align-items-center">
                            <!-- Microphone Toggle -->
                            <button id="micBtn" class="btn btn-outline-light me-2" onclick="toggleMicrophone()">
                                <i id="micIcon" class="fas fa-microphone"></i>
                            </button>
                            
                            <!-- Camera Toggle -->
                            <button id="cameraBtn" class="btn btn-outline-light me-2" onclick="toggleCamera()">
                                <i id="cameraIcon" class="fas fa-video"></i>
                            </button>
                            
                            <!-- Screen Share -->
                            <button id="screenBtn" class="btn btn-outline-info me-2" onclick="toggleScreenShare()">
                                <i class="fas fa-desktop"></i>
                            </button>
                            
                            <!-- Chat Toggle -->
                            <button class="btn btn-outline-success me-2" onclick="toggleChat()">
                                <i class="fas fa-comment"></i>
                                <span id="unreadMessages" class="badge bg-danger ms-1" style="display: none;">0</span>
                            </button>
                            
                            <!-- Settings -->
                            <button class="btn btn-outline-secondary me-3" data-bs-toggle="modal" data-bs-target="#settingsModal">
                                <i class="fas fa-cog"></i>
                            </button>
                            
                            <!-- End Call -->
                            <button id="endCallBtn" class="btn btn-danger" onclick="endConsultation()">
                                <i class="fas fa-phone-slash"></i> End Call
                            </button>
                        </div>
                        
                        <!-- Connection Quality Indicator -->
                        <div class="text-center mt-2">
                            <small class="text-light">
                                Connection: 
                                <span id="connectionQuality" class="badge bg-success">Excellent</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Appointment Details -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle"></i> Consultation Details
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-5"><strong>Doctor:</strong></div>
                        <div class="col-7">Dr. {{ appointment.doctor.first_name }} {{ appointment.doctor.last_name }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-5"><strong>Date:</strong></div>
                        <div class="col-7">{{ appointment.date.strftime('%B %d, %Y') }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-5"><strong>Time:</strong></div>
                        <div class="col-7">{{ appointment.time.strftime('%I:%M %p') }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-5"><strong>Duration:</strong></div>
                        <div class="col-7">
                            {% if consultation.duration_minutes %}
                                {{ consultation.duration_minutes }} minutes
                            {% else %}
                                <span id="liveDuration">00:00</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-5"><strong>Room ID:</strong></div>
                        <div class="col-7">
                            <code>{{ consultation.room_id }}</code>
                            <button class="btn btn-sm btn-outline-secondary ms-1" onclick="copyRoomId()">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-5"><strong>Status:</strong></div>
                        <div class="col-7">
                            {% if consultation.status == 'active' %}
                                <span class="badge bg-success">Active</span>
                            {% elif consultation.status == 'completed' %}
                                <span class="badge bg-primary">Completed</span>
                            {% elif consultation.status == 'scheduled' %}
                                <span class="badge bg-warning">Waiting</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ consultation.status.title() }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Panel -->
            <div id="chatPanel" class="card border-0 shadow-sm" style="height: 400px; display: none;">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-comment"></i> Chat
                    </h6>
                    <button class="btn btn-sm btn-outline-light" onclick="toggleChat()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="card-body p-0 d-flex flex-column">
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="flex-grow-1 p-3" style="overflow-y: auto; max-height: 300px;">
                        <!-- Messages will be added here dynamically -->
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="border-top p-3">
                        <div class="input-group">
                            <input type="text" id="chatInput" class="form-control" placeholder="Type a message..." 
                                   onkeypress="handleChatKeyPress(event)">
                            <button class="btn btn-success" onclick="sendChatMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Technical Support -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0">
                        <i class="fas fa-life-ring"></i> Need Help?
                    </h6>
                </div>
                <div class="card-body">
                    <p class="small mb-2">Experiencing technical issues?</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-sm btn-outline-warning" onclick="testConnection()">
                            <i class="fas fa-wifi"></i> Test Connection
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="refreshDevices()">
                            <i class="fas fa-sync"></i> Refresh Devices
                        </button>
                        <a href="/support/telemedicine" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-question-circle"></i> Help Center
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cog"></i> Video Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Camera Selection -->
                <div class="mb-3">
                    <label class="form-label">Camera</label>
                    <select id="cameraSelect" class="form-select">
                        <option>Loading cameras...</option>
                    </select>
                </div>
                
                <!-- Microphone Selection -->
                <div class="mb-3">
                    <label class="form-label">Microphone</label>
                    <select id="microphoneSelect" class="form-select">
                        <option>Loading microphones...</option>
                    </select>
                </div>
                
                <!-- Speaker Selection -->
                <div class="mb-3">
                    <label class="form-label">Speaker</label>
                    <select id="speakerSelect" class="form-select">
                        <option>Loading speakers...</option>
                    </select>
                </div>
                
                <!-- Video Quality -->
                <div class="mb-3">
                    <label class="form-label">Video Quality</label>
                    <select id="videoQuality" class="form-select">
                        <option value="720p">HD (720p)</option>
                        <option value="480p">Standard (480p)</option>
                        <option value="360p">Low (360p)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="applySettings()">Apply Settings</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let localStream = null;
let remoteStream = null;
let peerConnection = null;
let isVideoEnabled = true;
let isAudioEnabled = true;
let consultationStartTime = null;
let timerInterval = null;

// WebRTC configuration
const rtcConfig = {
    iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
    ]
};

// Initialize consultation when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeConsultation();
    loadDevices();
    
    {% if consultation.status == 'active' %}
    startTimer();
    {% endif %}
});

async function initializeConsultation() {
    try {
        // Get user media
        localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
        });
        
        document.getElementById('localVideo').srcObject = localStream;
        
        // Hide connection status overlay
        document.getElementById('connectionStatus').style.display = 'none';
        
        // Initialize peer connection
        setupPeerConnection();
        
        // Join the consultation room
        joinConsultationRoom();
        
    } catch (error) {
        console.error('Error accessing media devices:', error);
        showError('Unable to access camera or microphone. Please check your permissions.');
    }
}

function setupPeerConnection() {
    peerConnection = new RTCPeerConnection(rtcConfig);
    
    // Add local stream tracks
    localStream.getTracks().forEach(track => {
        peerConnection.addTrack(track, localStream);
    });
    
    // Handle remote stream
    peerConnection.ontrack = function(event) {
        remoteStream = event.streams[0];
        document.getElementById('remoteVideo').srcObject = remoteStream;
        document.getElementById('waitingOverlay').style.display = 'none';
    };
    
    // Handle ICE candidates
    peerConnection.onicecandidate = function(event) {
        if (event.candidate) {
            // Send candidate to signaling server
            sendSignalingMessage({
                type: 'ice-candidate',
                candidate: event.candidate,
                roomId: '{{ consultation.room_id }}'
            });
        }
    };
    
    // Monitor connection state
    peerConnection.onconnectionstatechange = function() {
        updateConnectionQuality(peerConnection.connectionState);
    };
}

function joinConsultationRoom() {
    // Mark patient as joined
    fetch('/telemedicine/consultation/{{ consultation.id }}/join', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Successfully joined consultation room');
            // Start signaling if consultation is active
            if (data.status === 'active') {
                startSignaling();
            }
        }
    })
    .catch(error => {
        console.error('Error joining consultation room:', error);
    });
}

function toggleMicrophone() {
    isAudioEnabled = !isAudioEnabled;
    const audioTrack = localStream.getAudioTracks()[0];
    if (audioTrack) {
        audioTrack.enabled = isAudioEnabled;
    }
    
    const micIcon = document.getElementById('micIcon');
    const micBtn = document.getElementById('micBtn');
    
    if (isAudioEnabled) {
        micIcon.className = 'fas fa-microphone';
        micBtn.className = 'btn btn-outline-light me-2';
    } else {
        micIcon.className = 'fas fa-microphone-slash';
        micBtn.className = 'btn btn-danger me-2';
    }
}

function toggleCamera() {
    isVideoEnabled = !isVideoEnabled;
    const videoTrack = localStream.getVideoTracks()[0];
    if (videoTrack) {
        videoTrack.enabled = isVideoEnabled;
    }
    
    const cameraIcon = document.getElementById('cameraIcon');
    const cameraBtn = document.getElementById('cameraBtn');
    
    if (isVideoEnabled) {
        cameraIcon.className = 'fas fa-video';
        cameraBtn.className = 'btn btn-outline-light me-2';
    } else {
        cameraIcon.className = 'fas fa-video-slash';
        cameraBtn.className = 'btn btn-danger me-2';
    }
}

function toggleScreenShare() {
    // Implement screen sharing functionality
    navigator.mediaDevices.getDisplayMedia({ video: true })
        .then(stream => {
            const videoTrack = stream.getVideoTracks()[0];
            const sender = peerConnection.getSenders().find(s => 
                s.track && s.track.kind === 'video'
            );
            
            if (sender) {
                sender.replaceTrack(videoTrack);
            }
            
            videoTrack.onended = () => {
                // Switch back to camera when screen sharing ends
                const cameraStream = localStream.getVideoTracks()[0];
                sender.replaceTrack(cameraStream);
            };
        })
        .catch(error => {
            console.error('Error sharing screen:', error);
        });
}

function toggleChat() {
    const chatPanel = document.getElementById('chatPanel');
    if (chatPanel.style.display === 'none') {
        chatPanel.style.display = 'block';
        // Clear unread messages badge
        document.getElementById('unreadMessages').style.display = 'none';
    } else {
        chatPanel.style.display = 'none';
    }
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (message) {
        // Add message to chat
        addChatMessage('You', message, true);
        
        // Send to signaling server
        sendSignalingMessage({
            type: 'chat-message',
            message: message,
            roomId: '{{ consultation.room_id }}',
            sender: 'patient'
        });
        
        input.value = '';
    }
}

function handleChatKeyPress(event) {
    if (event.key === 'Enter') {
        sendChatMessage();
    }
}

function addChatMessage(sender, message, isOwn = false) {
    const chatMessages = document.getElementById('chatMessages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-2 ${isOwn ? 'text-end' : ''}`;
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-2 rounded ${isOwn ? 'bg-primary text-white' : 'bg-light'}">
            <small class="fw-bold">${sender}:</small><br>
            ${message}
        </div>
        <div class="small text-muted">${new Date().toLocaleTimeString()}</div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Show unread messages badge if chat is hidden
    if (!isOwn && document.getElementById('chatPanel').style.display === 'none') {
        const badge = document.getElementById('unreadMessages');
        const count = parseInt(badge.textContent) || 0;
        badge.textContent = count + 1;
        badge.style.display = 'inline';
    }
}

function endConsultation() {
    if (confirm('Are you sure you want to end the consultation?')) {
        // Stop all tracks
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
        }
        
        // Close peer connection
        if (peerConnection) {
            peerConnection.close();
        }
        
        // Stop timer
        if (timerInterval) {
            clearInterval(timerInterval);
        }
        
        // Notify server
        fetch('/telemedicine/consultation/{{ consultation.id }}/end', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to feedback page
                window.location.href = '/patient/feedback/{{ appointment.id }}';
            }
        })
        .catch(error => {
            console.error('Error ending consultation:', error);
        });
    }
}

function startTimer() {
    consultationStartTime = new Date();
    timerInterval = setInterval(updateTimer, 1000);
}

function updateTimer() {
    if (consultationStartTime) {
        const now = new Date();
        const diff = now - consultationStartTime;
        const minutes = Math.floor(diff / 60000);
        const seconds = Math.floor((diff % 60000) / 1000);
        
        const timerText = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        document.getElementById('consultationTimer').textContent = timerText;
        
        const liveDuration = document.getElementById('liveDuration');
        if (liveDuration) {
            liveDuration.textContent = timerText;
        }
    }
}

function updateConnectionQuality(state) {
    const qualityElement = document.getElementById('connectionQuality');
    
    switch (state) {
        case 'connected':
            qualityElement.textContent = 'Excellent';
            qualityElement.className = 'badge bg-success';
            break;
        case 'connecting':
            qualityElement.textContent = 'Connecting';
            qualityElement.className = 'badge bg-warning';
            break;
        case 'disconnected':
            qualityElement.textContent = 'Disconnected';
            qualityElement.className = 'badge bg-danger';
            break;
        default:
            qualityElement.textContent = 'Unknown';
            qualityElement.className = 'badge bg-secondary';
    }
}

function copyRoomId() {
    navigator.clipboard.writeText('{{ consultation.room_id }}')
        .then(() => {
            alert('Room ID copied to clipboard');
        })
        .catch(error => {
            console.error('Error copying room ID:', error);
        });
}

function testConnection() {
    // Simple connection test
    fetch('/telemedicine/test-connection')
        .then(response => response.json())
        .then(data => {
            alert(`Connection test result: ${data.status} (${data.latency}ms)`);
        })
        .catch(error => {
            alert('Connection test failed');
        });
}

function refreshDevices() {
    loadDevices();
    alert('Device list refreshed');
}

async function loadDevices() {
    try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        
        const cameraSelect = document.getElementById('cameraSelect');
        const microphoneSelect = document.getElementById('microphoneSelect');
        const speakerSelect = document.getElementById('speakerSelect');
        
        // Clear existing options
        [cameraSelect, microphoneSelect, speakerSelect].forEach(select => {
            if (select) select.innerHTML = '';
        });
        
        devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            option.textContent = device.label || `${device.kind} ${device.deviceId.substring(0, 8)}`;
            
            if (device.kind === 'videoinput' && cameraSelect) {
                cameraSelect.appendChild(option);
            } else if (device.kind === 'audioinput' && microphoneSelect) {
                microphoneSelect.appendChild(option);
            } else if (device.kind === 'audiooutput' && speakerSelect) {
                speakerSelect.appendChild(option);
            }
        });
    } catch (error) {
        console.error('Error loading devices:', error);
    }
}

function applySettings() {
    // Apply device and quality settings
    const cameraId = document.getElementById('cameraSelect').value;
    const microphoneId = document.getElementById('microphoneSelect').value;
    const videoQuality = document.getElementById('videoQuality').value;
    
    // Update constraints based on quality
    let videoConstraints = { deviceId: cameraId };
    
    switch (videoQuality) {
        case '720p':
            videoConstraints.width = 1280;
            videoConstraints.height = 720;
            break;
        case '480p':
            videoConstraints.width = 640;
            videoConstraints.height = 480;
            break;
        case '360p':
            videoConstraints.width = 480;
            videoConstraints.height = 360;
            break;
    }
    
    // Restart stream with new settings
    navigator.mediaDevices.getUserMedia({
        video: videoConstraints,
        audio: { deviceId: microphoneId }
    })
    .then(stream => {
        // Replace local stream
        localStream.getTracks().forEach(track => track.stop());
        localStream = stream;
        document.getElementById('localVideo').srcObject = stream;
        
        // Update peer connection tracks
        stream.getTracks().forEach(track => {
            const sender = peerConnection.getSenders().find(s => 
                s.track && s.track.kind === track.kind
            );
            if (sender) {
                sender.replaceTrack(track);
            }
        });
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
        modal.hide();
    })
    .catch(error => {
        console.error('Error applying settings:', error);
        alert('Failed to apply settings');
    });
}

function sendSignalingMessage(message) {
    // In a real implementation, this would send messages to a signaling server
    // For now, we'll just log them
    console.log('Signaling message:', message);
}

function showError(message) {
    alert(message); // In a real app, use a proper notification system
}

// Handle beforeunload to clean up resources
window.addEventListener('beforeunload', function() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
    }
    if (peerConnection) {
        peerConnection.close();
    }
});
</script>
{% endblock %}