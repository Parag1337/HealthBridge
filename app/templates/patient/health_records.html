{% extends "base.html" %}

{% block title %}Health Records - HealthBridge Ai{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-1">
                        <i class="fas fa-file-medical"></i> My Health Records
                    </h2>
                    <p class="text-muted mb-0">Comprehensive view of your medical history and health data</p>
                </div>
                <div>
                    <a href="{{ url_for('patient.medical_documents') }}" class="btn btn-outline-primary">
                        <i class="fas fa-folder-open"></i> Medical Documents
                    </a>
                    <a href="{{ url_for('patient.dashboard') }}" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Information Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user"></i> Patient Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Name:</strong></td>
                                    <td>{{ current_user.first_name }} {{ current_user.last_name }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Email:</strong></td>
                                    <td>{{ current_user.email }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td>{{ current_user.phone or 'Not provided' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Blood Type:</strong></td>
                                    <td>
                                        {% if current_user.blood_type %}
                                            <span class="badge bg-danger">{{ current_user.blood_type }}</span>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Date of Birth:</strong></td>
                                    <td>{{ current_user.date_of_birth.strftime('%B %d, %Y') if current_user.date_of_birth else 'Not provided' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Gender:</strong></td>
                                    <td>{{ current_user.gender or 'Not specified' }}</td>
                                </tr>
                                <tr>
                                    <td><strong>Allergies:</strong></td>
                                    <td>
                                        {% if current_user.allergies %}
                                            <span class="badge bg-warning text-dark">{{ current_user.allergies }}</span>
                                        {% else %}
                                            <span class="text-muted">None reported</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <td><strong>Last Checkup:</strong></td>
                                    <td>
                                        {% if health_metrics.last_checkup %}
                                            {{ health_metrics.last_checkup.strftime('%B %d, %Y') }}
                                        {% else %}
                                            <span class="text-muted">No recent checkups</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    {% if not current_user.blood_type or not current_user.allergies %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Incomplete Profile:</strong> Please update your medical information for better healthcare.
                        <a href="{{ url_for('auth.edit_profile') }}" class="btn btn-warning btn-sm ms-2">
                            <i class="fas fa-edit"></i> Update Profile
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Health Metrics Dashboard -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-heartbeat"></i> Health Metrics
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-heart text-danger fa-2x mb-2"></i>
                                <h6>Blood Pressure</h6>
                                <strong class="text-success">{{ health_metrics.blood_pressure }}</strong>
                                <small class="d-block text-muted">Normal</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-heartbeat text-danger fa-2x mb-2"></i>
                                <h6>Heart Rate</h6>
                                <strong class="text-success">{{ health_metrics.heart_rate }}</strong>
                                <small class="d-block text-muted">Normal</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-thermometer-half text-warning fa-2x mb-2"></i>
                                <h6>Temperature</h6>
                                <strong class="text-success">{{ health_metrics.temperature }}</strong>
                                <small class="d-block text-muted">Normal</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded">
                                <i class="fas fa-weight text-primary fa-2x mb-2"></i>
                                <h6>Weight</h6>
                                <strong class="text-info">{{ health_metrics.weight }}</strong>
                                <small class="d-block text-muted">Healthy range</small>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle"></i>
                            Health metrics are based on your latest medical examination. 
                            Regular checkups help maintain accurate records.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Medical History -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-history"></i> Medical History
                    </h5>
                </div>
                <div class="card-body">
                    {% if appointments_by_year %}
                        {% for year, appointments in appointments_by_year.items() %}
                        <div class="mb-4">
                            <h6 class="text-primary border-bottom pb-2">{{ year }}</h6>
                            {% for appointment, doctor in appointments %}
                            <div class="d-flex mb-3 p-3 border rounded bg-light">
                                <div class="me-3">
                                    <div class="bg-success rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                        <i class="fas fa-user-md text-white"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">Dr. {{ doctor.first_name }} {{ doctor.last_name }}</h6>
                                            <p class="mb-1 text-muted">{{ doctor.specialization or 'General Practice' }}</p>
                                            <p class="mb-1">
                                                <i class="fas fa-calendar text-primary me-1"></i>
                                                {{ appointment.date.strftime('%B %d, %Y') }}
                                                <i class="fas fa-clock text-primary ms-3 me-1"></i>
                                                {{ appointment.time.strftime('%I:%M %p') }}
                                            </p>
                                            {% if appointment.reason %}
                                            <p class="mb-1">
                                                <i class="fas fa-notes-medical text-info me-1"></i>
                                                <strong>Reason:</strong> {{ appointment.reason }}
                                            </p>
                                            {% endif %}
                                            {% if appointment.notes %}
                                            <p class="mb-0">
                                                <i class="fas fa-clipboard text-warning me-1"></i>
                                                <strong>Notes:</strong> {{ appointment.notes }}
                                            </p>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-success">{{ appointment.status.title() }}</span>
                                            <span class="badge bg-info">{{ appointment.appointment_type.title() }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-file-medical fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">No medical history found</h5>
                            <p class="text-muted">Your completed appointments will appear here</p>
                            <a href="{{ url_for('patient.find_doctors') }}" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Book Your First Appointment
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Prescription History -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-prescription-bottle"></i> Prescription History
                    </h5>
                </div>
                <div class="card-body">
                    {% if prescription_history %}
                        {% for prescription in prescription_history %}
                        <div class="mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="mb-0">Dr. {{ prescription.doctor.first_name }} {{ prescription.doctor.last_name }}</h6>
                                <span class="badge bg-{{ 'success' if prescription.status == 'Active' else 'secondary' }}">
                                    {{ prescription.status }}
                                </span>
                            </div>
                            <p class="mb-1 text-muted small">
                                <i class="fas fa-calendar me-1"></i>
                                {{ prescription.created_at.strftime('%B %d, %Y') }}
                            </p>
                            {% if prescription.diagnosis %}
                            <p class="mb-1 small">
                                <strong>Diagnosis:</strong> {{ prescription.diagnosis }}
                            </p>
                            {% endif %}
                            
                            <!-- Show medications if available -->
                            {% set medications = prescription.medications %}
                            {% if medications %}
                            <div class="mt-2">
                                <strong class="small">Medications:</strong>
                                <ul class="list-unstyled small ms-3 mt-1">
                                    {% for med in medications %}
                                    <li>
                                        <i class="fas fa-pills text-info me-1"></i>
                                        {{ med.medication_name }} - {{ med.dosage }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-prescription-bottle fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No prescriptions found</p>
                        </div>
                    {% endif %}
                </div>
                <div class="card-footer">
                    <a href="{{ url_for('patient.prescriptions') }}" class="btn btn-info btn-sm w-100">
                        <i class="fas fa-eye"></i> View All Prescriptions
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add smooth animations to medical history items
    const historyItems = document.querySelectorAll('.border.rounded.bg-light');
    historyItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
        }, index * 100);
    });
});
</script>
{% endblock %}